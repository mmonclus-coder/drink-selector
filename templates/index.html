<!DOCTYPE html>
<html>
<head>



  <title>Drink Selection</title>
  <style>
    .slot {
      width: 120px;
      height: 150px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      background-color: #f9f9f9;
      border: 2px dashed #ccc;
      margin: 10px;
      display: inline-block;
      cursor: pointer;
    }

    #slots-container {
      margin-bottom: 20px;
    }

    #drinkModal h4 {
      margin-top: 0;
    }
  </style>
</head>
<body>

  <div id="tokenSection">
    <h3>Enter Your Access Token</h3>
    <input type="text" id="accessToken" placeholder="6-digit token">
    <button onclick="checkToken()">Submit Token</button>
  </div>

  <div id="selectionSection" style="display:none;">
    <div id="slots-container"></div>

    <form id="drinkForm">
      <input type="text" name="customerName" placeholder="Your Name" required><br><br>
      <button type="submit">Submit</button>
    </form>
  </div>


  <div style="text-align: center; margin-bottom: 20px;">
    <img src="/static/logo.png" alt="Company Logo" style="max-width: 200px; height: auto;">
  </div>
  <h2>Select Drinks for Your Vending Machine</h2>



  <script>


    function checkToken() {
      const token = document.getElementById('accessToken').value;

      fetch('/validate_token', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ token })
      })
      .then(res => {
        if (!res.ok) throw new Error('Invalid token');
        return res.json();
      })
      .then(data => {
        document.getElementById('tokenSection').style.display = 'none';
        document.getElementById('selectionSection').style.display = 'block';

        // Call your slot generation logic here with data.slots
        generateDrinkSlots(data.slots);
      })
      .catch(err => {
        alert('Invalid or expired token.');
      });
    }


    const drinks = [
      { name: 'Coca Cola', img: '/static/coke.jpg' },
      { name: 'Sprite', img: '/static/sprite.jpg' },
      { name: 'Pepsi', img: '/static/pepsi.jpg' },
      { name: 'Ginger Ale', img: '/static/ginger.jpg' },
      { name: 'Dr Pepper', img: '/static/pepper.jpg' }
    ];

    let slots = [];  // Declare globally so you can use it on form submit

  function generateDrinkSlots(slotCount) {
    slots = new Array(slotCount).fill(null);
    const container = document.getElementById('slots-container');
    container.innerHTML = ''; // Clear any previous slots

    slots.forEach((_, index) => {
      const slotDiv = document.createElement('div');
      slotDiv.className = 'slot';
      slotDiv.dataset.index = index;
      slotDiv.onclick = () => showDrinkOptions(index, slotDiv);
      container.appendChild(slotDiv);
    });
  }

    const container = document.getElementById('slots-container');

    slots.forEach((_, index) => {
      const slotDiv = document.createElement('div');
      slotDiv.className = 'slot';
      slotDiv.dataset.index = index;
      slotDiv.onclick = () => showDrinkOptions(index, slotDiv);
      container.appendChild(slotDiv);
    });

    const modal = document.createElement('div');
    modal.id = 'drinkModal';
    modal.style.position = 'fixed';
    modal.style.top = '50%';
    modal.style.left = '50%';
    modal.style.transform = 'translate(-50%, -50%)';
    modal.style.background = '#fff';
    modal.style.border = '2px solid #ccc';
    modal.style.padding = '20px';
    modal.style.display = 'none';
    modal.style.zIndex = '1000';
    modal.style.maxHeight = '90vh';
    modal.style.overflowY = 'auto';
    document.body.appendChild(modal);

    function showDrinkOptions(slotIndex, slotDiv) {
      modal.innerHTML = '<h4>Select a drink:</h4>';

      drinks.forEach(drink => {
        const img = document.createElement('img');
        img.src = drink.img;
        img.alt = drink.name;
        img.title = drink.name;
        img.style.width = '150px';
        img.style.height = '150px';
        img.style.margin = '10px';
        img.style.cursor = 'pointer';

        img.onclick = () => {
          console.log("Setting slot to image:", drink.img);
          slots[slotIndex] = drink;

          // Clear any custom text
          slotDiv.textContent = '';
          slotDiv.style.display = 'inline-block';
          slotDiv.style.alignItems = '';
          slotDiv.style.justifyContent = '';
          slotDiv.style.fontSize = '';
          slotDiv.style.color = '';

          // Set background image
          slotDiv.style.backgroundImage = `url(${drink.img})`;
          slotDiv.title = drink.name;
          modal.style.display = 'none';
        };

        modal.appendChild(img);
      });

      // Custom drink option
      const customOption = document.createElement('div');
      customOption.innerText = 'Not on the list?';
      customOption.style.border = '1px solid #888';
      customOption.style.padding = '15px';
      customOption.style.margin = '10px';
      customOption.style.textAlign = 'center';
      customOption.style.cursor = 'pointer';
      customOption.style.fontWeight = 'bold';
      customOption.style.background = '#f0f0f0';

      customOption.onclick = () => {
        const userDrink = prompt('Enter the name of your drink:');
        if (userDrink && userDrink.trim() !== '') {
          const customDrink = { name: userDrink.trim(), img: null };
          slots[slotIndex] = customDrink;

          // Remove image and show typed name
          slotDiv.textContent = userDrink.trim();
          slotDiv.style.backgroundImage = 'none';
          slotDiv.style.fontSize = '14px';
          slotDiv.style.color = '#333';
          slotDiv.style.display = 'flex';
          slotDiv.style.alignItems = 'center';
          slotDiv.style.justifyContent = 'center';
          slotDiv.title = userDrink.trim();
          modal.style.display = 'none';
        }
      };

      modal.appendChild(customOption);

      modal.style.display = 'block';
    }

    // Submit form and send layout
    document.getElementById('drinkForm').onsubmit = (e) => {
      e.preventDefault();
      const name = e.target.customerName.value;
      fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, layout: slots })
      })
      .then(res => res.text())
      .then(alert)
      .catch(err => alert('Error submitting: ' + err));
    };
  </script>
</body>
</html>
